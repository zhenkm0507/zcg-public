# 斩词阁前端系统：视频与音频处理说明

> 本文档梳理了系统中视频与音频的加载、切换、播放等核心逻辑，详细说明了各类场景下的处理方式、加载顺序，以及主要涉及的代码文件与方法，便于维护和扩展。

---

## 1. 主要涉及的文件

- **布局与全局控制**
  - `frontend/src/components/Layout/index.tsx`  —— 全局布局组件，整合了客户端状态管理、视频音频切换、页面动画等所有布局逻辑。
  - `frontend/src/components/Layout/layout.module.css` —— 布局相关样式。
- **视频背景组件**
  - `frontend/src/components/VideoBackground/index.tsx` —— 视频播放的核心组件，支持多种配置。
  - `frontend/src/components/VideoBackground/videoBackground.module.css` —— 视频背景样式。
- **登录页**
  - `frontend/src/app/login/page.tsx` —— 登录页独立的视频、音频播放逻辑。

---

## 2. 视频与音频的加载与切换逻辑

### 2.1 登录页（/login）
- **视频与音频均循环播放**。
- 代码片段：
  ```tsx
  <VideoBackground videoSrc={'/videos/login.mp4'} loop />
  <audio src="/audios/login.mp3" autoPlay loop controls={false} style={{ display: 'none' }} />
  ```
- 加载顺序：页面加载时，视频和音频几乎同时挂载并自动播放。
- 相关文件：`frontend/src/app/login/page.tsx`

### 2.2 一级菜单页面（如/、/study/records、/study/word_bank等）
- **视频与音频均不循环播放**。
- 切换一级菜单时，视频和音频会同步切换并从头播放。
- **无论是菜单栏点击切换，还是直接在浏览器输入一级菜单地址回车访问，视频和音频都会被正确加载和播放。**
- 代码片段（在Layout/index.tsx中）：
  ```tsx
  <VideoBackground
    key={`video-${getTopMenuKey(pathname)}`}
    videoSrc={currentVideo}
    onVideoEnd={handleVideoEnd}
    isTransition={isTransitioning}
    loop={isLoginPage}
  />
  {currentAudio && (
    <audio
      key={`audio-${getTopMenuKey(pathname)}`}
      src={currentAudio}
      autoPlay
      loop={isLoginPage}
      controls={false}
      style={{ display: 'none' }}
    />
  )}
  ```
- **切换与加载机制说明**：
  - 监听一级菜单变化（通过`getTopMenuKey(pathname)`），只有一级菜单切换时才会：
    - `setCurrentVideo(getVideoSrc())`，`setCurrentAudio(getAudioSrc())`
    - 这样 `<VideoBackground>` 和 `<audio>` 的 key 都会变化，React 会销毁旧组件并新建新组件，确保音视频都从头播放。
  - **首次加载页面（直接输入一级菜单地址回车）时**，也会同步设置并加载音频和视频，保证两者加载逻辑完全一致。
  - 相关 useEffect 代码：
    ```tsx
    // 初始化时设置视频和音频，只在一级菜单页面加载
    useEffect(() => {
        if (isInitialLoad) {
            const topMenu = getTopMenuKey(pathname);
            // 只有一级菜单页面才加载视频和音频
            if (
                pathname.startsWith(topMenu) ||
                pathname === '/' // 首页
            ) {
                const videoSrc = getVideoSrc();
                setCurrentVideo(videoSrc);
                setCurrentAudio(getAudioSrc());
                setIsTransitioning(true);
                setShowContent(false);
            } else {
                setShowContent(true);
                setIsTransitioning(false);
            }
            setIsInitialLoad(false);
        }
    }, [isInitialLoad, pathname]);
    // 一级菜单切换时同步切换视频和音频
    useEffect(() => {
      if (!isInitialLoad) {
        const currentTopMenu = getTopMenuKey(pathname);
        const prevTopMenu = prevTopMenuKey.current;
        if (currentTopMenu !== prevTopMenu) {
          setCurrentVideo(getVideoSrc());
          setCurrentAudio(getAudioSrc());
          setIsTransitioning(true);
          setShowContent(false);
        }
        prevTopMenuKey.current = currentTopMenu;
      }
    }, [pathname, isInitialLoad]);
    ```
- 相关文件：`frontend/src/components/Layout/index.tsx`

---

## 3. 主要方法与状态说明

### 3.1 getTopMenuKey(pathname)
- 作用：根据当前路由，提取一级菜单 key，用于判断菜单切换、音视频切换的时机。
- 位置：`frontend/src/components/Layout/index.tsx`

### 3.2 getVideoSrc(path)
- 作用：根据当前路由，返回对应的菜单视频路径。
- 位置：`frontend/src/components/Layout/index.tsx`

### 3.3 getAudioSrc(path)
- 作用：根据当前路由，返回对应的菜单音频路径。
- 位置：`frontend/src/components/Layout/index.tsx`

### 3.4 currentVideo, currentAudio
- 作用：当前正在播放的视频、音频路径。
- 变化时机：仅在一级菜单切换时更新。
- 位置：`frontend/src/components/Layout/index.tsx`（useState）

### 3.5 <VideoBackground /> 组件
- 负责视频的实际播放，支持 loop、playbackRate、预加载、缩放等参数。
- 位置：`frontend/src/components/VideoBackground/index.tsx`

---

## 4. 加载与播放顺序说明

- **登录页**：页面加载时，视频和音频几乎同时挂载并循环播放。
- **一级菜单页面**：
  1. 路由切换到新一级菜单时，先设置新的视频和音频路径。
  2. React 销毁旧的 `<VideoBackground>` 和 `<audio>`，新建新组件。
  3. 新的视频和音频自动从头播放。
  4. 视频播放结束后，内容区才显示（有过渡动画和兜底5秒机制）。

---

## 5. 组件架构说明

### 5.1 合并后的组件结构
```
RootLayout (app/layout.tsx)
└── Layout (components/Layout/index.tsx)
    ├── 客户端状态管理（用户信息、词库管理）
    ├── 视频音频管理（加载、切换、播放）
    ├── 页面动画效果（framer-motion）
    ├── 菜单导航（处理菜单点击和路由跳转）
    └── 组件生命周期控制（通过key控制重新挂载）
```

### 5.2 关键设计优势
- **统一的状态管理**：所有布局相关状态都在一个组件中管理
- **简化的组件层级**：减少了中间层，降低了组件间耦合
- **集中的逻辑处理**：问题定位和调试更加简单
- **优化的性能**：通过合理的key控制，避免不必要的组件重新挂载

---

## 6. 兜底与异常处理

- 视频播放有5秒兜底机制，若5秒内未能正常播放完毕，强制显示内容区。
- 音频播放由 `<audio>` 标签的自动播放机制控制，若浏览器策略阻止自动播放，用户交互后会恢复。

---

## 7. 维护建议

- 如需扩展菜单的音视频资源，只需在 `getVideoSrc` 和 `getAudioSrc` 方法中配置对应路由的资源路径。
- 如需调整播放策略（如某些菜单循环、某些不循环），只需在渲染 `<VideoBackground>` 和 `<audio>` 时根据路由判断 loop 属性。
- 所有核心逻辑均集中在 `frontend/src/components/Layout/index.tsx` 和 `frontend/src/components/VideoBackground/index.tsx`，便于统一维护。

---

> 文档维护：如有更新请同步修改本文件。 