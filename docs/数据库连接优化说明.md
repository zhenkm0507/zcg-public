# 数据库连接优化说明

## 优化方案

### 1. 连接池配置优化

我们优化了 `backend/framework/database/db_factory.py` 中的连接池配置：

```python
engine = create_engine(
    settings.SQLALCHEMY_DATABASE_URI, 
    echo=settings.SQL_ECHO,
    future=True,
    # 连接池配置 - 解决连接意外关闭问题
    pool_size=10,  # 连接池大小
    max_overflow=20,  # 超出pool_size后最多可以创建的连接数
    pool_timeout=30,  # 连接池获取连接的超时时间
    pool_recycle=3600,  # 连接在连接池中的回收时间（秒），1小时
    pool_pre_ping=True,  # 每次连接前ping一下，确保连接有效
    pool_reset_on_return='commit',  # 连接返回时重置状态
    # JSON序列化配置
    json_serializer=lambda obj: json.dumps(obj, ensure_ascii=False, cls=CustomJSONEncoder),
    json_deserializer=lambda obj: json.loads(obj)
)
```

**关键参数说明：**

- `pool_size=10`: 连接池基础大小，适合中小型应用
- `max_overflow=20`: 允许的最大溢出连接数
- `pool_timeout=30`: 获取连接的超时时间
- `pool_recycle=3600`: 连接回收时间，防止长时间空闲连接
- `pool_pre_ping=True`: 连接前ping检测，确保连接有效
- `pool_reset_on_return='commit'`: 连接返回时自动提交，避免事务状态问题

### 2. 连接监控功能

#### 健康检查端点

访问 `/api/v1/hc/health` 可以查看系统整体状态，包括数据库连接状态。

访问 `/api/v1/hc/database` 可以查看详细的数据库连接池信息。

#### 监控脚本

使用 `backend/scripts/monitor_db_connection.py` 脚本实时监控连接状态：

```bash
# 监控模式（默认）
python backend/scripts/monitor_db_connection.py --mode monitor --interval 30

# 连接稳定性测试
python backend/scripts/monitor_db_connection.py --mode test --test-count 100 --test-interval 1
```


## 监控和诊断

### 1. 实时监控

```bash
# 启动连接监控
python backend/scripts/monitor_db_connection.py --mode monitor --interval 10
```

### 2. 连接稳定性测试

```bash
# 测试连接稳定性
python backend/scripts/monitor_db_connection.py --mode test --test-count 1000 --test-interval 0.5
```

### 3. API健康检查

```bash
# 检查系统健康状态
curl http://localhost:8000/api/v1/hc/health

# 检查数据库状态
curl http://localhost:8000/api/v1/hc/database
```

## 常见问题排查

### 1. 连接池耗尽

**症状：** 频繁出现连接超时错误

**解决方案：**
- 增加 `pool_size` 和 `max_overflow`
- 检查是否有连接泄漏（未正确关闭）
- 优化SQL查询性能

### 2. 连接被数据库服务器关闭

**症状：** 长时间空闲后出现连接错误

**解决方案：**
- 确保 `pool_recycle` 设置合理（建议1小时）
- 启用 `pool_pre_ping=True`
- 检查数据库服务器的连接超时设置

### 3. 网络不稳定

**症状：** 偶发性连接错误

**解决方案：**
- 检查网络质量
- 增加连接超时时间
- 监控连接状态

## 性能调优建议

### 1. 连接池大小调优

```python
# 根据并发用户数调整
pool_size = min(32, (cpu_count * 2) + effective_spindle_count)
max_overflow = pool_size * 2
```

### 2. 连接回收时间

```python
# 根据数据库服务器设置调整
pool_recycle = 3600  # 1小时，根据数据库连接超时设置
```

### 3. 监控指标

- 连接池使用率：`checked_out / (pool_size + overflow)`
- 无效连接数：`invalid`
- 连接获取超时次数

## 错误处理建议

### 1. 应用层错误处理

在业务代码中正确处理数据库异常：

```python
@transactional
def create_user(user_data: dict):
    try:
        # 数据库操作
        user = User(**user_data)
        session.add(user)
        return user
    except Exception as e:
        logger.error(f"创建用户失败: {str(e)}")
        # 根据业务需求决定是否重新抛出异常
        raise
```

### 2. 监控告警

设置监控告警，及时发现连接问题：

```python
# 定期检查连接状态
def check_db_health():
    if not check_db_connection():
        # 发送告警通知
        send_alert("数据库连接异常")
```

## 总结

通过以上优化，您的数据库连接稳定性将得到显著提升：

1. **连接池配置优化** - 防止连接意外关闭
2. **实时监控** - 及时发现和诊断问题
3. **健康检查** - 提供系统状态API
4. **错误处理** - 在应用层正确处理异常

建议您先运行监控脚本观察连接状态，然后根据实际情况调整连接池参数。如果仍然出现连接问题，可以通过监控数据进一步诊断具体原因。 